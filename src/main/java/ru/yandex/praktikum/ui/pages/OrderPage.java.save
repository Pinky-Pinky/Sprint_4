package ru.yandex.praktikum.ui.pages;

import org.openqa.selenium.*;
import org.openqa.selenium.support.FindBy;
import org.openqa.selenium.support.PageFactory;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;
import java.time.Duration;
import java.util.List;

public class OrderPage {
    // Локаторы элементов
    private static final By MODAL_WINDOW_LOCATOR = By.xpath("//div[contains(@class, 'Order_Modal__YZ-d3')]");
    private static final String STATION_LOCATOR_TEMPLATE = "//div[normalize-space(text())='%s']";
    private static final By DROPDOWN_OPTION_LOCATOR = By.className("Dropdown-option");
    private static final String RENTAL_PERIOD_LOCATOR_TEMPLATE =
            "//div[contains(@class, 'Dropdown-option') and normalize-space(text())='%s']";

    private final WebDriver driver;
    private final WebDriverWait wait;

    // Локаторы элементов
    private static final String STATION_LOCATOR_TEMPLATE = "//div[normalize-space(text())='%s']";
    private static final By MODAL_WINDOW_LOCATOR = By.xpath("//div[contains(@class, 'Order_Modal__YZ-d3')]");
    private static final By DROPDOWN_OPTION_LOCATOR = By.className("Dropdown-option");

    // Элементы первой страницы
    @FindBy(css = "[placeholder='* Имя']")
    private WebElement nameInput;

    @FindBy(css = "[placeholder='* Фамилия']")
    private WebElement surnameInput;

    @FindBy(css = "[placeholder='* Адрес: куда привезти заказ']")
    private WebElement addressInput;

    @FindBy(css = "[placeholder='* Станция метро']")
    private WebElement metroInput;

    @FindBy(css = "[placeholder='* Телефон: на него позвонит курьер']")
    private WebElement phoneInput;

    @FindBy(xpath = "//button[text()='Далее']")
    private WebElement nextButton;

    // Элементы второй страницы
    @FindBy(css = "[placeholder='* Когда привезти самокат']")
    private WebElement dateInput;

    @FindBy(className = "Dropdown-placeholder")
    private WebElement periodDropdown;

    @FindBy(css = "label.Checkbox_Label__3wxSf")
    private List<WebElement> colorLabels;

    @FindBy(css = "[placeholder='Комментарий для курьера']")
    private WebElement commentInput;

    @FindBy(xpath = "//button[contains(@class, 'Button_Middle') and text()='Заказать']")
    private WebElement orderButton;

    // Модальное окно подтверждения
    @FindBy(xpath = "//div[contains(@class, 'Order_Modal__YZ-d3')]//button[contains(text(), 'Да')]")
    private WebElement confirmButton;

    @FindBy(xpath = "//div[contains(@class, 'Order_Modal__YZ-d3')]//div[contains(@class, 'Order_ModalHeader__3FDaJ')]")
    private WebElement successMessage;

    public OrderPage(WebDriver driver) {
        this.driver = driver;
        this.wait = new WebDriverWait(driver, Duration.ofSeconds(40));
        PageFactory.initElements(driver, this);
    }

    // Методы первой страницы
    public void setName(String name) {
        wait.until(ExpectedConditions.visibilityOf(nameInput)).sendKeys(name);
        System.out.println("Введено имя: " + name);
    }

    public void setSurname(String surname) {
        wait.until(ExpectedConditions.visibilityOf(surnameInput)).sendKeys(surname);
        System.out.println("Введена фамилия: " + surname);
    }

    public void setAddress(String address) {
        wait.until(ExpectedConditions.visibilityOf(addressInput)).sendKeys(address);
        System.out.println("Введен адрес: " + address);
    }

    public void selectMetroStation(String station) {
        metroInput.sendKeys(station);

<<<<<<< HEAD:src/main/java/pageObjects/OrderPage.java
        // Формируем локатор с использованием шаблона
        String locator = String.format(STATION_LOCATOR_TEMPLATE, station);

        WebElement stationElement = wait.until(
                ExpectedConditions.elementToBeClickable(By.xpath(locator))
        );
=======
        // Явное ожидание появления выпадающего списка
        wait.until(ExpectedConditions.visibilityOfElementLocated(
                By.xpath("//div[@class='select-search__select']")
        ));

        String locator = String.format(STATION_LOCATOR_TEMPLATE, station);
        WebElement stationElement = wait.until(
                ExpectedConditions.elementToBeClickable(By.xpath(locator))
        );

        // Прокрутка и клик
        ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", stationElement);>>>>>>> f363bbe (Дополнительные изменения):src/main/java/ru/yandex/praktikum/ui/pages/OrderPage.java
        stationElement.click();
    }

    public void setPhone(String phone) {
        wait.until(ExpectedConditions.visibilityOf(phoneInput)).sendKeys(phone);
        System.out.println("Введен телефон: " + phone);
    }

    public void clickNextButton() {
        WebElement button = wait.until(ExpectedConditions.elementToBeClickable(nextButton));
        ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", button);
        button.click();
        System.out.println("Нажата кнопка 'Далее'");
    }

    // Методы второй страницы
    public void setDeliveryDateWithEnter(String date) {
        WebElement dateField = wait.until(ExpectedConditions.visibilityOf(dateInput));
        dateField.sendKeys(date);
        dateField.sendKeys(Keys.ENTER);
        System.out.println("Введена дата доставки (ENTER): " + date);
    }

    public void setDeliveryDate(String date) {
        WebElement dateField = wait.until(ExpectedConditions.visibilityOf(dateInput));
        dateField.sendKeys(date);
        dateField.sendKeys(Keys.ESCAPE);
        System.out.println("Введена дата доставки: " + date);
    }

    public void selectRentalPeriod(String period) {
        WebElement dropdown = wait.until(ExpectedConditions.elementToBeClickable(periodDropdown));
        dropdown.click();

        wait.until(ExpectedConditions.visibilityOfElementLocated(DROPDOWN_OPTION_LOCATOR));

        String locator = String.format(RENTAL_PERIOD_LOCATOR_TEMPLATE, period);
        WebElement option = wait.until(ExpectedConditions.elementToBeClickable(By.xpath(locator)));
        option.click();
    }

    public void selectScooterColor(String color) {
        wait.until(ExpectedConditions.visibilityOfAllElements(colorLabels));

        colorLabels.stream()
                .filter(e -> e.getText().toLowerCase().contains(color.toLowerCase()))
                .findFirst()
                .ifPresentOrElse(e -> {
                    ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView(true);", e);
                    e.click();
                    System.out.println("Выбран цвет: " + color);
                }, () -> {
                    throw new RuntimeException("Цвет '" + color + "' не найден среди чекбоксов");
                });
    }

    public void setComment(String comment) {
        wait.until(ExpectedConditions.visibilityOf(commentInput)).sendKeys(comment);
        System.out.println("Введен комментарий: " + comment);
    }

    public void clickOrderButton() {
        WebElement button = wait.until(ExpectedConditions.elementToBeClickable(orderButton));
        ((JavascriptExecutor) driver).executeScript("arguments[0].scrollIntoView({block: 'center'});", button);
        ((JavascriptExecutor) driver).executeScript("arguments[0].click();", button);

        wait.until(ExpectedConditions.visibilityOfElementLocated(MODAL_WINDOW_LOCATOR));
    }

    public void clickConfirmButton() {
        try {
            WebElement button = wait.until(ExpectedConditions.elementToBeClickable(confirmButton));
            ((JavascriptExecutor) driver).executeScript("arguments[0].click();", button);
            System.out.println("Кнопка 'Да' успешно нажата");
        } catch (TimeoutException e) {
            throw new RuntimeException("Кнопка 'Да' не найдена: " + e.getMessage());
        }
    }

    public String getSuccessMessageText() {
        WebElement message = wait.until(ExpectedConditions.visibilityOf(successMessage));
        return message.getText().trim();
    }

    // Геттеры для тестов
    public WebElement getNameInput() {
        return nameInput;
    }

    public WebElement getDateInput() {
        return dateInput;
    }

    public WebElement getConfirmButton() {
        return confirmButton;
    }
}
